import{isPlainObject as m,isRedirect as F,isNotFound as O}from"@tanstack/react-router";import{AsyncLocalStorage as z}from"node:async_hooks";import{H3Event as E,getRequestURL as M,getRequestWebStream as P,getResponseStatus as U,eventHandler as W}from"h3";var J="Invariant failed";function B(e,n){if(!e)throw new Error(J)}function K(e={}){let n,t=!1;const r=s=>{if(n&&n!==s)throw new Error("Context conflict")};let o;if(e.asyncContext){const s=e.AsyncLocalStorage||globalThis.AsyncLocalStorage;s?o=new s:console.warn("[unctx] `AsyncLocalStorage` is not provided.")}const a=()=>{if(o){const s=o.getStore();if(s!==void 0)return s}return n};return{use:()=>{const s=a();if(s===void 0)throw new Error("Context is not available");return s},tryUse:()=>a(),set:(s,c)=>{c||r(s),n=s,t=!0},unset:()=>{n=void 0,t=!1},call:(s,c)=>{r(s),n=s;try{return o?o.run(s,c):c()}finally{t||(n=void 0)}},async callAsync(s,c){n=s;const y=()=>{n=s},f=()=>n===s?y:void 0;$.add(f);try{const d=o?o.run(s,c):c();return t||(n=void 0),await d}finally{$.delete(f)}}}}function V(e={}){const n={};return{get(t,r={}){return n[t]||(n[t]=K({...e,...r})),n[t]}}}const b=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof global<"u"?global:typeof window<"u"?window:{},L="__unctx__",G=b[L]||(b[L]=V()),Q=(e,n={})=>G.get(e,n),q="__unctx_async_handlers__",$=b[q]||(b[q]=new Set),l={stringify:e=>JSON.stringify(e,function(t,r){const o=this[t],a=S.find(s=>s.stringifyCondition(o));return a?a.stringify(o):r}),parse:e=>JSON.parse(e,function(t,r){const o=this[t];if(m(o)){const a=S.find(s=>s.parseCondition(o));if(a)return a.parse(o)}return r}),encode:e=>{if(Array.isArray(e))return e.map(t=>l.encode(t));if(m(e))return Object.fromEntries(Object.entries(e).map(([t,r])=>[t,l.encode(r)]));const n=S.find(t=>t.stringifyCondition(e));return n?n.stringify(e):e},decode:e=>{if(m(e)){const n=S.find(t=>t.parseCondition(e));if(n)return n.parse(e)}return Array.isArray(e)?e.map(n=>l.decode(n)):m(e)?Object.fromEntries(Object.entries(e).map(([n,t])=>[n,l.decode(t)])):e}},g=(e,n,t,r)=>({key:e,stringifyCondition:n,stringify:o=>({[`$${e}`]:t(o)}),parseCondition:o=>Object.hasOwn(o,`$${e}`),parse:o=>r(o[`$${e}`])}),S=[g("undefined",e=>e===void 0,()=>0,()=>{}),g("date",e=>e instanceof Date,e=>e.toISOString(),e=>new Date(e)),g("error",e=>e instanceof Error,e=>({...e,message:e.message,stack:void 0,cause:e.cause}),e=>Object.assign(new Error(e.message),e)),g("formData",e=>e instanceof FormData,e=>{const n={};return e.forEach((t,r)=>{const o=n[r];o!==void 0?Array.isArray(o)?o.push(t):n[r]=[o,t]:n[r]=t}),n},e=>{const n=new FormData;return Object.entries(e).forEach(([t,r])=>{Array.isArray(r)?r.forEach(o=>n.append(t,o)):n.append(t,r)}),n}),g("bigint",e=>typeof e=="bigint",e=>e.toString(),e=>BigInt(e))];function X(e){let n;const t=D(e),r={duplex:"half",method:e.method,headers:e.headers};return e.node.req.body instanceof ArrayBuffer?new Request(t,{...r,body:e.node.req.body}):new Request(t,{...r,get body(){return n||(n=ne(e),n)}})}function Y(e){return e.web??(e.web={request:X(e),url:D(e)}),e.web.request}function Z(){return H()}const j=Symbol("$HTTPEvent");function k(e){return typeof e=="object"&&(e instanceof E||e?.[j]instanceof E||e?.__is_event__===!0)}function R(e){return function(...n){var t;const r=n[0];if(k(r))n[0]=r instanceof E||r.__is_event__?r:r[j];else{if(!((t=globalThis.app.config.server.experimental)!=null&&t.asyncContext))throw new Error("AsyncLocalStorage was not enabled. Use the `server.experimental.asyncContext: true` option in your app configuration to enable it. Or, pass the instance of HTTPEvent that you have as the first argument to the function.");n.unshift(Z())}return e(...n)}}const D=R(M),ee=R(U),ne=R(P);function te(){var e;return Q("nitro-app",{asyncContext:!!((e=globalThis.app.config.server.experimental)!=null&&e.asyncContext),AsyncLocalStorage:z})}function H(){const e=te().use().event;if(!e)throw new Error("No HTTPEvent found in AsyncLocalStorage. Make sure you are using the function within the server runtime.");return e}const re={},ue=W(oe),v=re;async function oe(e){const n=Y(e);return await ie({request:n,event:e})}function se(e){return e.replace(/^\/|\/$/g,"")}async function ie({request:e,event:n}){const t=new AbortController,r=t.signal,o=()=>t.abort();n.node.req.on("close",o);const a=e.method,s=new URL(e.url,"http://localhost:3000"),c=new RegExp(`${se("/_server")}/([^/?#]+)`),y=s.pathname.match(c),f=y?y[1]:null,d=Object.fromEntries(s.searchParams.entries()),C="createServerFn"in d;if(typeof f!="string")throw new Error("Invalid server action param for serverFnId: "+f);const x=v[f];if(!x)throw console.log("serverFnManifest",v),new Error("Server function info not found for "+f);let w;if(w=await x.importer(),!w)throw console.log("serverFnManifest",v),new Error("Server function module not resolved for "+f);const p=w[x.functionName];if(!p)throw console.log("serverFnManifest",v),console.log("fnModule",w),new Error(`Server function module export not resolved for serverFn ID: ${f}`);const I=["multipart/form-data","application/x-www-form-urlencoded"],_=await(async()=>{try{let i=await(async()=>{if(e.headers.get("Content-Type")&&I.some(u=>{var A;return(A=e.headers.get("Content-Type"))==null?void 0:A.includes(u)}))return B(a.toLowerCase()!=="get","GET requests with FormData payloads are not supported"),await p(await e.formData(),r);if(a.toLowerCase()==="get"){let u=d;return C&&(u=d.payload),u=u&&l.parse(u),await p(u,r)}const h=await e.text(),T=l.parse(h);return C?await p(T,r):await p(...T,r)})();return i instanceof Response||!C&&(i=i.result,i instanceof Response)?i:F(i)||O(i)?N(i):new Response(i!==void 0?l.stringify(i):void 0,{status:ee(H()),headers:{"Content-Type":"application/json"}})}catch(i){return i instanceof Response?i:F(i)||O(i)?N(i):(console.info(),console.info("Server Fn Error!"),console.info(),console.error(i),console.info(),new Response(l.stringify(i),{status:500,headers:{"Content-Type":"application/json"}}))}})();if(n.node.req.removeListener("close",o),_.headers.get("Content-Type")==="application/json"){const h=await _.clone().text();h&&JSON.stringify(JSON.parse(h))}return _}function N(e){const{headers:n,...t}=e;return new Response(JSON.stringify(t),{status:200,headers:{"Content-Type":"application/json",...n||{}}})}export{ue as default};
